version: '3.8'

services:
  # Servidor ChromaDB
  chromadb:
    image: chromadb/chroma:latest
    container_name: chromadb-server
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=False
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    ports:
      - "8001:8000"  # Expor ChromaDB na porta 8001 do host
    networks:
      - rag-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/v1/heartbeat || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  # Servidor Ollama (LLM Local)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama-server
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"  # Expor Ollama na porta 11434 do host
    networks:
      - rag-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:11434/api/tags || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    # GPU support (descomente se tiver GPU NVIDIA)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # Aplicação RAG com Chainlit
  rag-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag-chainlit-app
    depends_on:
      chromadb:
        condition: service_healthy
      ollama:
        condition: service_healthy
    volumes:
      - ./data/uploads:/app/data/uploads
      - ./config.yaml:/app/config.yaml:ro
    environment:
      # ChromaDB
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000

      # Ollama (LLM Local)
      - OLLAMA_HOST=ollama
      - OLLAMA_PORT=11434

      # Configuração LLM
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - LLM_MODEL=${LLM_MODEL:-llama3.1:8b}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}

      # Chainlit
      - CHAINLIT_HOST=0.0.0.0
      - CHAINLIT_PORT=8000

      # Debug
      - DEBUG=${DEBUG:-False}
    ports:
      - "8000:8000"  # Expor Chainlit na porta 8000 do host
    networks:
      - rag-network
    restart: unless-stopped

volumes:
  chromadb-data:
    driver: local
    name: rag-chromadb-data
  ollama-data:
    driver: local
    name: rag-ollama-data

networks:
  rag-network:
    driver: bridge
    name: rag-network
